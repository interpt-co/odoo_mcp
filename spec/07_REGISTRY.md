# 07 — Model/Field/Method Registry

| Field        | Value                              |
|-------------|-------------------------------------|
| Document ID | SPEC-07                             |
| Title       | Model/Field/Method Registry          |
| Status      | Draft                               |
| Depends On  | SPEC-02                             |
| Referenced By | SPEC-04, SPEC-06, SPEC-08         |

---

## 1. Overview

The registry is the server's knowledge base about the connected Odoo instance. It stores model definitions, field metadata, available methods, and state machines. The registry serves two purposes:

1. **Tool intelligence**: Provides context for LLM prompts and tool descriptions (field names, types, required fields, valid states).
2. **Validation**: Validates tool inputs (model exists, field exists, method is callable).

The registry supports two construction modes: **static** (pre-generated from Odoo source code) and **dynamic** (introspected from the live instance at runtime). A **merged** registry combines both sources.

---

## 2. Registry Data Model

**REQ-07-01**: The registry MUST store data in this structure:

```python
@dataclass
class FieldInfo:
    name: str                           # Technical name (e.g., "partner_id")
    label: str                          # Human-readable label (e.g., "Customer")
    type: str                           # Field type: char, integer, float, boolean, text,
                                        #   html, date, datetime, binary, selection,
                                        #   many2one, one2many, many2many, reference,
                                        #   monetary, properties
    required: bool
    readonly: bool
    store: bool                         # True if stored in database
    help: str | None                    # Help text
    relation: str | None                # Related model (for relational fields)
    selection: list[tuple[str, str]] | None  # Selection options [(value, label), ...]
    default: Any | None                 # Default value (from default_get or AST)
    groups: str | None                  # Access groups (comma-separated XML IDs)
    compute: bool                       # True if computed field
    depends: list[str] | None          # Compute dependencies

@dataclass
class MethodInfo:
    name: str                           # Method name (e.g., "action_confirm")
    description: str                    # Docstring summary or empty string
    accepts_kwargs: bool                # Whether the method accepts keyword arguments
    decorator: str | None               # "api.model", "api.multi", etc.

@dataclass
class ModelInfo:
    model: str                          # Technical name (e.g., "sale.order")
    name: str                           # Human-readable name (e.g., "Sales Order")
    description: str | None             # Model description
    transient: bool                     # True for TransientModel (wizards)
    fields: dict[str, FieldInfo]        # field_name → FieldInfo
    methods: dict[str, MethodInfo]      # method_name → MethodInfo
    states: list[tuple[str, str]] | None  # State selection if model has "state" field
    parent_models: list[str]            # Models this inherits from (_inherit)
    has_chatter: bool                   # True if model inherits mail.thread

@dataclass
class Registry:
    models: dict[str, ModelInfo]        # model_name → ModelInfo
    version: str                        # Odoo version this registry was built for
    build_mode: str                     # "static", "dynamic", "merged"
    build_timestamp: str                # ISO 8601 timestamp
    model_count: int
    field_count: int
```

---

## 3. Static Registry

### 3.1 Generation

**REQ-07-02**: The static registry MUST be generated by the `odoo-mcp-registry` CLI tool, which parses Odoo addon source code using Python AST analysis.

**REQ-07-03**: The generator MUST accept these parameters:

| Parameter | Type | Description |
|-----------|------|-------------|
| `--addons-path` | string (path) | Comma-separated paths to Odoo addon directories |
| `--output` | string (path) | Output file path (JSON). Default: `odoo_mcp/registry/static_data.json` |
| `--models` | string | Comma-separated model names to include. Default: all discovered models. |
| `--version` | string | Odoo version label for the output |

**REQ-07-04**: The AST parser MUST extract:

1. **Model detection**: Classes with `_name = '...'` or `_inherit = '...'`.
2. **Field extraction**: Assignments using `fields.Char(...)`, `fields.Many2one(...)`, etc. Parameters are extracted from the AST keyword arguments.
3. **Method extraction**: Methods named `action_*` or `button_*`. Extracts the first line of docstring.
4. **Inheritance resolution**: If `_inherit` extends an existing model, fields and methods are merged.

**REQ-07-05**: The generator MUST handle:
- Single inheritance: `_inherit = 'sale.order'` (extends existing model)
- Multiple inheritance: `_inherit = ['mail.thread', 'mail.activity.mixin']`
- New model: `_name = 'my.model'` with `_inherit` for mixins
- `_inherits` delegation inheritance (note: different from `_inherit`)

### 3.2 Runtime Introspection Script

**REQ-07-06**: The project MUST include a runtime introspection script (`scripts/runtime_introspect.py`) that can be run inside an Odoo shell to generate registry data from a live instance. This script:

1. Iterates target models (configurable list, defaults to common business models).
2. For each model, reads `_fields` for field info and scans `dir()` for `action_*`/`button_*` methods.
3. Outputs JSON delimited by markers for easy parsing:
   ```
   === RUNTIME_REGISTRY_JSON_START ===
   { ... }
   === RUNTIME_REGISTRY_JSON_END ===
   ```

**REQ-07-07**: The default target models for runtime introspection:

```python
DEFAULT_INTROSPECTION_MODELS = [
    'res.partner', 'res.users', 'res.company',
    'sale.order', 'sale.order.line',
    'purchase.order', 'purchase.order.line',
    'account.move', 'account.move.line',
    'stock.picking', 'stock.move', 'stock.move.line',
    'stock.quant', 'stock.warehouse', 'stock.location',
    'product.template', 'product.product', 'product.category',
    'crm.lead', 'crm.stage',
    'helpdesk.ticket', 'helpdesk.stage', 'helpdesk.team',
    'project.project', 'project.task', 'project.milestone',
    'hr.employee', 'hr.department', 'hr.leave',
    'calendar.event',
    'mail.message', 'mail.activity',
    'ir.attachment',
]
```

### 3.3 Static Data File Format

**REQ-07-08**: The static registry file MUST be JSON with this structure:

```json
{
  "version": "17.0",
  "generated_at": "2025-02-09T12:00:00Z",
  "generator_version": "0.1.0",
  "source": "ast_parse",
  "models": {
    "sale.order": {
      "name": "Sales Order",
      "description": "Sales Order",
      "transient": false,
      "fields": {
        "name": {
          "label": "Order Reference",
          "type": "char",
          "required": true,
          "readonly": true,
          "store": true,
          "help": null,
          "relation": null,
          "selection": null
        }
      },
      "methods": {
        "action_confirm": {
          "description": "Confirm the quotation",
          "accepts_kwargs": false
        }
      },
      "states": [["draft", "Quotation"], ["sale", "Sales Order"]],
      "parent_models": ["mail.thread", "mail.activity.mixin"],
      "has_chatter": true
    }
  }
}
```

---

## 4. Dynamic Registry

### 4.1 Live Introspection via API

**REQ-07-09**: At startup, after connection is established (SPEC-02), the server MUST build a dynamic registry by introspecting the live Odoo instance via the API.

**REQ-07-10**: The introspection process:

1. **Get installed modules**: `search_read('ir.module.module', [('state', '=', 'installed')], ['name', 'shortdesc'])`.
2. **Get available models**: `search_read('ir.model', [('transient', '=', False)], ['model', 'name', 'info', 'transient'])` for the common models. Limit to models the user has read access to.
3. **Get field metadata**: For each target model, call `fields_get(attributes=['string', 'type', 'required', 'readonly', 'store', 'help', 'relation', 'selection'])`.
4. **Get available methods**: Query the registry for known `action_*`/`button_*` methods. This requires calling `search_read` on a dummy domain and catching specific errors, or relying on the static registry for method information (methods are not easily discoverable via the external API).

**REQ-07-11**: The dynamic introspection MUST be throttled to avoid overwhelming the Odoo instance:
- Maximum 5 concurrent `fields_get` calls.
- Total introspection time limit: 60 seconds. After timeout, use whatever was collected.

**REQ-07-12**: The dynamic registry MUST be cached in memory. It MUST be refreshed:
- On explicit request (via a tool or configuration reload).
- If a `fields_get` call returns different results than cached (detected opportunistically during tool execution).
- Never automatically on a timer (to avoid unnecessary load).

### 4.2 Model Existence Checking

**REQ-07-13**: The registry MUST provide a fast model existence check:

```python
async def model_exists(self, model_name: str) -> bool:
    """Check if a model exists and is accessible."""
```

Implementation:
1. Check the in-memory registry first.
2. If not found, attempt `search_count(model, [], limit=0)`.
3. Cache the result (both positive and negative).

---

## 5. Registry Merge

**REQ-07-14**: When both static and dynamic data are available, they MUST be merged:

1. Start with the static registry as the base.
2. For each model in the dynamic registry:
   - If the model exists in static: merge fields (dynamic wins for conflicts — it reflects the live instance).
   - If the model does not exist in static: add it entirely from dynamic.
3. Methods: static registry is preferred (it has richer information from AST parsing, including docstrings). Dynamic can add newly discovered methods.
4. States: dynamic is preferred (reflects current selection values which may differ from source code).

**REQ-07-15**: The merge MUST log any conflicts at `debug` level:
```
Registry merge: sale.order.new_field - added from dynamic (not in static)
Registry merge: sale.order.state - selection values updated from dynamic
```

---

## 6. Registry Access API

**REQ-07-16**: The registry MUST expose these query methods:

```python
class ModelRegistry:
    def get_model(self, model_name: str) -> ModelInfo | None: ...
    def get_field(self, model_name: str, field_name: str) -> FieldInfo | None: ...
    def get_method(self, model_name: str, method_name: str) -> MethodInfo | None: ...
    def list_models(self, filter: str | None = None) -> list[ModelInfo]: ...
    def get_required_fields(self, model_name: str) -> list[FieldInfo]: ...
    def get_state_field(self, model_name: str) -> FieldInfo | None: ...
    def get_relational_fields(self, model_name: str) -> list[FieldInfo]: ...
    def method_accepts_kwargs(self, method_name: str) -> bool: ...
    async def model_exists(self, model_name: str) -> bool: ...
```

---

## 7. Known Method Registry

**REQ-07-17**: The registry MUST maintain a set of methods known to NOT accept keyword arguments:

```python
NO_KWARGS_METHODS = {
    "action_cancel", "action_confirm", "action_draft", "action_done",
    "action_lock", "action_unlock", "button_validate", "button_draft",
    "button_cancel", "button_confirm", "action_post", "action_open",
    "action_set_draft", "action_quotation_send", "action_view_invoice",
    "copy", "name_get", "name_search", "read", "search", "search_read",
    "search_count", "fields_get", "default_get", "onchange",
}
```

**REQ-07-18**: When `odoo_core_execute` calls a method in `NO_KWARGS_METHODS`, it MUST strip all keyword arguments from the call to prevent Odoo errors.

---

## 8. Field Type Reference

**REQ-07-19**: The registry MUST include a mapping of Odoo field types for documentation and validation:

| Odoo Type | Python Type | JSON Type | Notes |
|-----------|------------|-----------|-------|
| `char` | str | string | |
| `text` | str | string | Multi-line |
| `html` | str | string | HTML content |
| `integer` | int | integer | |
| `float` | float | number | |
| `monetary` | float | number | Has `currency_field` |
| `boolean` | bool | boolean | |
| `date` | str | string | Format: YYYY-MM-DD |
| `datetime` | str | string | Format: YYYY-MM-DD HH:MM:SS (UTC) |
| `binary` | str | string | Base64 encoded |
| `selection` | str | string | Value from selection list |
| `many2one` | int/list | integer | Returns [id, name] or id |
| `one2many` | list[int] | array | List of IDs |
| `many2many` | list[int] | array | List of IDs |
| `reference` | str | string | Format: "model,id" |
| `properties` | dict | object | Dynamic properties (Odoo 17+) |

---

## 9. Registry as MCP Resource

**REQ-07-20**: The registry data MUST be exposed via MCP resources (SPEC-06):
- `odoo://model/{model_name}/fields` — served from `registry.get_model(model_name).fields`
- `odoo://model/{model_name}/methods` — served from `registry.get_model(model_name).methods`
- `odoo://model/{model_name}/states` — served from `registry.get_model(model_name).states`
